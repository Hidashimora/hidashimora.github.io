name: Update VPN config

on:
  schedule:
    # Каждый час в 0 минут
    - cron: '0 * * * *'
  workflow_dispatch: # Ручной запуск из вкладки Actions

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch source configs
        run: |
          curl -sL "https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/26.txt" -o full.txt

      - name: Keep 1/4 of configs and save
        run: |
          # Оставляем только строки с конфигами (vless, trojan, vmess, ss...)
          grep -E '^(vless|trojan|vmess|ss|hy2)://' full.txt > filtered.txt || true
          # Берём каждую 4-ю строку ≈ 1/4 от общего числа
          awk 'NR % 4 == 1' filtered.txt > new_vpn.txt
          # Если получилось мало конфигов — берём все отфильтрованные
          if [ ! -s new_vpn.txt ] && [ -s filtered.txt ]; then
            cp filtered.txt new_vpn.txt
          fi
          # Перезаписываем vpn.txt только если есть конфиги (не ломаем подписку пустым файлом)
          if [ -s new_vpn.txt ]; then
            cp new_vpn.txt vpn.txt
            wc -l vpn.txt
          else
            echo "No configs from source; leaving existing vpn.txt unchanged"
          fi

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add vpn.txt
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "chore: update VPN config ($(date -u +%Y-%m-%dT%H:%MZ))"
            git push
          fi

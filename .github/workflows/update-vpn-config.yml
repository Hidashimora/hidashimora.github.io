name: Update VPN config

on:
  push:
    branches: [main]
  schedule:
    # Максимальная частота в GitHub Actions — раз в минуту (30 сек cron не поддерживает)
    - cron: '* * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch and reduce all 26 lists (1/4 configs each, max 300)
        run: |
          mkdir -p configs
          BASE="https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror"
          MAX=300
          printf 'OpenRay\n5ubscrpt10n\nproxy-minging\nAutoVPN\nV2RayCFGDumper\nopenproxylist\nv2ray-configs\ncid-vpn-config\ntelegram-v2ray-configs\n.proxy\nV2rayCollector\n.proxy\nconfig\nMineral\nConfig-Collector\nFree-servers\nV2rayCollector_Py\nv2ray\nV2rayCollector\nProxy-List\nkamaji\nxray-config-toolkit\nXray\nSTRUGOV\nV2RayConfig\nОбход SNI/CIDR\n' > names_aven.txt
          for i in $(seq 1 26); do
            curl -sLf "${BASE}/${i}.txt" -o full.txt || true
            touch full.txt
            grep -E '^(vless|trojan|vmess|ss|hy2)://' full.txt > filtered.txt || true
            if [ "$i" -eq 26 ]; then grep -v '\.ru' filtered.txt > filtered2.txt && mv filtered2.txt filtered.txt; fi
            N=$(wc -l < filtered.txt)
            if [ "$N" -eq 0 ]; then
              cp filtered.txt new.txt
            elif [ "$N" -lt "$MAX" ]; then
              cp filtered.txt new.txt
            else
              quarter=$((N / 4))
              if [ "$quarter" -le "$MAX" ]; then
                awk 'NR % 4 == 1' filtered.txt > new.txt
              else
                awk -v T="$N" -v target="$MAX" 'int((NR-1)*target/T) != int((NR-2)*target/T)' filtered.txt > new.txt
              fi
            fi
            if [ ! -s new.txt ] && [ -s filtered.txt ]; then
              cp filtered.txt new.txt
            fi
            if [ -s new.txt ]; then
              name=$(sed -n "${i}p" names_aven.txt)
              echo "# Подписка $i | $name (AvenCores/goida-vpn-configs)" > "configs/${i}.txt"
              cat new.txt >> "configs/${i}.txt"
              echo "  configs/${i}.txt: $(wc -l < new.txt) servers"
            else
              echo "  configs/${i}.txt: no configs, skipped"
            fi
          done

      - name: Fetch igareck/vpn-configs-for-russia (27–34); if &lt;300 configs — no 1/4, else 1/4 max 300
        run: |
          BASE="https://raw.githubusercontent.com/igareck/vpn-configs-for-russia/main"
          MAX=300
          n=27
          titles='Shadowsocks+All (чёрный список)|VLESS все (чёрный список)|VLESS 150 для телефона (чёрный)|CIDR белый список mobile 1 (igareck)|CIDR белый список mobile 2 (igareck)|CIDR белый список все (igareck)|CIDR VK/Ya/CDN/Beeline (igareck)|SNI белый список (igareck)'
          for name in "BLACK_SS%2BAll_RUS.txt" "BLACK_VLESS_RUS.txt" "BLACK_VLESS_RUS_mobile.txt" \
                      "Vless-Reality-White-Lists-Rus-Mobile.txt" "Vless-Reality-White-Lists-Rus-Mobile-2.txt" \
                      "WHITE-CIDR-RU-all.txt" "WHITE-CIDR-RU-checked.txt" "WHITE-SNI-RU-all.txt"; do
            curl -sLf "${BASE}/${name}" -o full.txt || true
            touch full.txt
            grep -E '^(vless|trojan|vmess|ss|hy2)://' full.txt > filtered.txt || true
            N=$(wc -l < filtered.txt)
            if [ "$N" -eq 0 ]; then
              cp filtered.txt new.txt
            elif [ "$N" -lt "$MAX" ]; then
              cp filtered.txt new.txt
            else
              quarter=$((N / 4))
              if [ "$quarter" -le "$MAX" ]; then
                awk 'NR % 4 == 1' filtered.txt > new.txt
              else
                awk -v T="$N" -v target="$MAX" 'int((NR-1)*target/T) != int((NR-2)*target/T)' filtered.txt > new.txt
              fi
            fi
            if [ ! -s new.txt ] && [ -s filtered.txt ]; then cp filtered.txt new.txt; fi
            if [ -s new.txt ]; then
              title=$(echo "$titles" | cut -d'|' -f$((n-26)))
              echo "# Подписка $n | $title (igareck/vpn-configs-for-russia)" > "configs/${n}.txt"
              cat new.txt >> "configs/${n}.txt"
              echo "  configs/${n}.txt: $(wc -l < new.txt) servers (from ${name})"
            else
              echo "  configs/${n}.txt: no configs, skipped (${name})"
            fi
            n=$((n + 1))
          done

      - name: Fetch full AvenCores lists (1.1–1.26), save to configs
        run: |
          BASE="https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror"
          printf 'OpenRay\n5ubscrpt10n\nproxy-minging\nAutoVPN\nV2RayCFGDumper\nopenproxylist\nv2ray-configs\ncid-vpn-config\ntelegram-v2ray-configs\n.proxy\nV2rayCollector\n.proxy\nconfig\nMineral\nConfig-Collector\nFree-servers\nV2rayCollector_Py\nv2ray\nV2rayCollector\nProxy-List\nkamaji\nxray-config-toolkit\nXray\nSTRUGOV\nV2RayConfig\nОбход\n' > names_aven.txt
          for i in $(seq 1 26); do
            curl -sLf "${BASE}/${i}.txt" -o full.txt || true
            touch full.txt
            grep -E '^(vless|trojan|vmess|ss|hy2)://' full.txt > filtered.txt || true
            if [ "$i" -eq 26 ]; then grep -v '\.ru' filtered.txt > filtered2.txt && mv filtered2.txt filtered.txt; fi
            name=$(sed -n "${i}p" names_aven.txt)
            f="1.${i}.txt"
            echo "# Подписка $f | $name (полный, AvenCores)" > "configs/$f"
            cat filtered.txt >> "configs/$f"
            echo "  configs/$f: $(wc -l < filtered.txt) servers"
          done

      - name: Generate counts.json (per-config and total unique servers)
        run: |
          echo '{' > configs/counts.json
          for i in $(seq 1 34); do
            c=0
            [ -f "configs/${i}.txt" ] && c=$(grep -cE '^(vless|trojan|vmess|ss|hy2)://' "configs/${i}.txt" 2>/dev/null || true)
            echo "  \"$i\": ${c:-0}," >> configs/counts.json
          done
          for i in $(seq 1 26); do
            key="1.$i"
            c=0
            [ -f "configs/${key}.txt" ] && c=$(grep -cE '^(vless|trojan|vmess|ss|hy2)://' "configs/${key}.txt" 2>/dev/null || true)
            echo "  \"$key\": ${c:-0}," >> configs/counts.json
          done
          total=$(for i in $(seq 1 34); do [ -f "configs/${i}.txt" ] && grep -E '^(vless|trojan|vmess|ss|hy2)://' "configs/${i}.txt"; done; for i in $(seq 1 26); do [ -f "configs/1.${i}.txt" ] && grep -E '^(vless|trojan|vmess|ss|hy2)://' "configs/1.${i}.txt"; done 2>/dev/null | sort -u | wc -l)
          echo "  \"totalUnique\": $total" >> configs/counts.json
          echo '}' >> configs/counts.json
          echo "  totalUnique: $total servers (no duplicates)"

      - name: Remove old config files from repo root (if any)
        run: |
          for f in $(seq 1 34 | sed 's/$/.txt/'); do rm -f "$f"; done

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add configs/
          git add -u
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git status --short
            git commit -m "chore: update VPN configs ($(date -u +%Y-%m-%dT%H:%MZ))"
            git push
          fi
